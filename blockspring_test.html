<html>
<head>
<title>iHub</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
<script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
<script src="https://cdn.blockspring.com/blockspring.js"></script>
<script type="text/javascript">

// Jquery no conflict method to avoid confict using $ symbol by other frameworks
var $x = jQuery.noConflict();
console.log("Version: "+$x.fn.jquery);

/**
 * CONSTANTS
 *  - TABLES
 *  - WORKSHEET_ID
*/
const STUDENTS_TABLE = { "TABLE_NAME": "STUDENTS_TABLE", "WID": [815095649, 987445403] };
const ATTENDANCE_RECORDS = { "TABLE_NAME": "ATTENDANCE_RECORDS", "WID": [0, 119545118]};

const CONSTANTS = { STUDENTS_TABLE, ATTENDANCE_RECORDS }

// Class Table Constructor
function TableContructor(){
        this.row_id = 1;

        // append and display html content
        this.construct = (data)=>{
            console.log(data);
            
            // parse header
            let header = `<th scope="col">#</th>`;
            Object.keys(data[0]).forEach(fieldName => header += `<th scope="col">${fieldName}</th>`);

            // parse content
            let content = data.reduce((rowStacks, rawData)=>{
                let row;
                Object.values(rawData).forEach(value => row += `<td>${value}</td>`) ;
                row = `<tr> \
                    <th scope=\"row\">${this.row_id}</th> \
                    ${row}
                </tr>`;

                this.row_id ++;
                return rowStacks + row;
            }, "");
            
            return { header, content };
        }
    }    


// jQuery convention for running when the document has been fully loaded:
jQuery(document).ready(() => {
    // init table contructor
    var tableContructor = new TableContructor();

    // Get query a student's profile 
    $('#readButton').click(() => {
        var matricInput = $('#matricBox').val();
        
        // Proceed if the matric Input is filled by user
        if(matricInput != ""){
            // format matric input
            var matric = `\'${matricInput}\'`;

            console.log('making ajax request to BlockSpring API');
            console.log(matric);
            
            // run Blockspring - GET Query method
            blockspring.runParsed("serversideapi", 
                { 
                    "method": 'GET', 
                    "doc_name": CONSTANTS.STUDENTS_TABLE.TABLE_NAME, 
                    "worksheet_id": CONSTANTS.STUDENTS_TABLE.WID[0],
                    "query": "SELECT B, C, D, E, F WHERE C CONTAINS"  + matric
                }, 
                function(res){
                    // display header and content in tabular form
                    let { header, content } = tableContructor.construct(res.params.data);
                    $('#table-header').html(header);
                    $('#student-table').html(content);
                }
            );   
        }
        
    });

    // Get query all students' profiles
    $('#allStudentsButton').click(() => {
        console.log("Quering all students...")

        // run Blockspring - GET Query all method
        blockspring.runParsed("serversideapi", 
            { 
                "method": 'GET', 
                "doc_name": CONSTANTS.STUDENTS_TABLE.TABLE_NAME, 
                "worksheet_id": CONSTANTS.STUDENTS_TABLE.WID[0],
                "query": "SELECT B, C, D, E, F"
            }, 
            function(res){
                // display content and header in tabular form
                let { header, content } = tableContructor.construct(res.params.data);
                $('#table-header').html(header);
                $('#student-table').html(content);
            });
    });

    // Post insert a student profile
    $('#insertButton').click(()=> {
        console.log("Posting data to GSheet...");
        
        // Take data from user input
        // var id;
        var name = $('#insertMatric').val();
        var job_id = $('#insertJI').val();
        var date = $('#insertDate').val();
        var day = $('#insertDay').val();
        var time_in = $('#insertTimein').val();
        var time_out = $('#insertTimeout').val(); 

        var values = [[98, name, job_id, date, day, time_in, time_out]];
        console.log(values);
        // run Blockspring - POST attendance method
        blockspring.runParsed("serversideapi",
            {
                "method": 'POST',
                "doc_name": CONSTANTS.ATTENDANCE_RECORDS.TABLE_NAME,
                "worksheet_id": CONSTANTS.ATTENDANCE_RECORDS.WID[0],
                "values": values
            },
            function(res){
                console.log(res.params);
            });
    });


    

});
</script>
</head>

<body>
<h1>BlockSpring test</h1>
<hr/>

<div>
    matric: <input id="matricBox" type="text" size="20"/>
    <button id="readButton">Get profile</button>
    <button id="allStudentsButton">Get all students</button>  
</div>

<br><br>
<div>
    Matric No: <input id="insertMatric" type="text" size="15"/>
    Job_ID: <input id="insertJI" type="text" size="10"/>
    Date: <input id="insertDate" type="text" size="10"/>
    Day: <input id="insertDay" type="text" size="10"/>
    Time in: <input id="insertTimein" type="text" size="10"/>
    Time out: <input id="insertTimeout" type="text" size="10"/>
    <button id="insertButton">Insert into database</button>  
</div>

<hr/>
<div id="status"></div>

<div class="container">
    <div class="table-responsive-lg">
        <table class="table">
        
        <thead class="thead-light">
            <tr id="table-header">
              <th scope="col">#</th>
              <th scope="col">Name</th>
              <th scope="col">Matric No</th>
              <th scope="col">Mobile phone</th>
              <th scope="col">Job ID</th>
            </tr>
          </thead>

        <tbody id="student-table">
        <!-- content from GSheet -->
        </tbody>
        
        </table>
    </div>    
</div>

</body>
</html>